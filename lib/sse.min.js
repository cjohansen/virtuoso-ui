var SSE=function(t,s){if(!(this instanceof SSE))return new SSE(t,s);this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.url=t,s=s||{},this.headers=s.headers||{},this.payload=void 0!==s.payload?s.payload:"",this.method=s.method||(this.payload?"POST":"GET"),this.withCredentials=!!s.withCredentials,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=this.INITIALIZING,this.progress=0,this.chunk="",this.addEventListener=function(t,s){void 0===this.listeners[t]&&(this.listeners[t]=[]),-1===this.listeners[t].indexOf(s)&&this.listeners[t].push(s)},this.removeEventListener=function(t,s){if(void 0!==this.listeners[t]){var e=[];this.listeners[t].forEach(function(t){t!==s&&e.push(t)}),0===e.length?delete this.listeners[t]:this.listeners[t]=e}},this.dispatchEvent=function(t){if(!t)return!0;t.source=this;var s="on"+t.type;return(!this.hasOwnProperty(s)||(this[s].call(this,t),!t.defaultPrevented))&&(!this.listeners[t.type]||this.listeners[t.type].every(function(s){return s(t),!t.defaultPrevented}))},this._setReadyState=function(t){var s=new CustomEvent("readystatechange");s.readyState=t,this.readyState=t,this.dispatchEvent(s)},this._onStreamFailure=function(t){this.dispatchEvent(new CustomEvent("error")),this.close()},this._onStreamProgress=function(t){if(this.xhr)if(200===this.xhr.status){this.readyState==this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this._setReadyState(this.OPEN));var s=this.xhr.responseText.substring(this.progress);this.progress+=s.length,s.split(/(\r\n|\r|\n){2}/g).forEach(function(t){0===t.trim().length?(this.dispatchEvent(this._parseEventChunk(this.chunk.trim())),this.chunk=""):this.chunk+=t}.bind(this))}else this._onStreamFailure(t)},this._onStreamLoaded=function(t){this._onStreamProgress(t),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk=""},this._parseEventChunk=function(t){if(!t||0===t.length)return null;var s={id:null,retry:null,data:"",event:"message"};t.split(/\n|\r\n|\r/).forEach(function(t){var e=(t=t.trimRight()).indexOf(this.FIELD_SEPARATOR);if(!(e<=0)){var i=t.substring(0,e);if(i in s){var h=t.substring(e+1).trimLeft();"data"===i?s[i]+=h:s[i]=h}}}.bind(this));var e=new CustomEvent(s.event);return e.data=s.data,e.id=s.id,e},this._checkStreamClosed=function(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this._setReadyState(this.CLOSED)},this.stream=function(){for(var t in this._setReadyState(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamFailure.bind(this)),this.xhr.open(this.method,this.url),this.headers)this.xhr.setRequestHeader(t,this.headers[t]);this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)},this.close=function(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this._setReadyState(this.CLOSED))}};
